<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Web NFC å¾ªç¯å†™å…¥æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 2rem;
      background: #f5f5f5;
    }
    button {
      padding: 12px 24px;
      font-size: 1.2rem;
      margin: 1rem;
      cursor: pointer;
    }
    #status {
      margin-top: 1rem;
      font-size: 1.1rem;
      color: #333;
    }
    #counter {
      font-weight: bold;
      color: #007bff;
    }
  </style>
</head>
<body>
  <h1>Web NFC å¾ªç¯å†™å…¥æµ‹è¯•</h1>
  <button id="startBtn">å¼€å§‹å¾ªç¯åˆ·NFC</button>
  <div id="status">è¯·å…ˆç‚¹å‡»æŒ‰é’®å¼€å§‹</div>
  <div>å½“å‰å†™å…¥æ¬¡æ•°ï¼š<span id="counter">0</span></div>

  <script>
    // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ Web NFC
    if (!("NDEFReader" in window)) {
      document.getElementById("status").textContent = "âš ï¸ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Web NFC";
      document.getElementById("startBtn").disabled = true;
    }

    const startBtn = document.getElementById("startBtn");
    const statusEl = document.getElementById("status");
    const counterEl = document.getElementById("counter");

    let writeCount = 0;
    let isRunning = false;
    const MAX_COUNT = 200_000_000_000; // 2000äº¿æ¬¡

    async function writeToTag(text) {
      try {
        const writer = new NDEFWriter();
        await writer.write(text);
        return true;
      } catch (error) {
        console.error("å†™å…¥å¤±è´¥:", error);
        return false;
      }
    }

    async function cycleWrite() {
      if (writeCount >= MAX_COUNT) {
        statusEl.textContent = "âœ… å·²å®Œæˆå…¨éƒ¨å†™å…¥ä»»åŠ¡ï¼";
        isRunning = false;
        return;
      }

      // æç¤ºç”¨æˆ·è´´ä¸Šæ ‡ç­¾ï¼ˆä»…é¦–æ¬¡ï¼‰
      if (writeCount === 0) {
        statusEl.textContent = "ğŸ“Œ è¯·å°† NFC æ ‡ç­¾è´´è¿‘è®¾å¤‡...";
        // ç­‰å¾…é¦–æ¬¡å†™å…¥è§¦å‘
        const success1 = await writeToTag("1");
        if (!success1) {
          statusEl.textContent = "âŒ æ ‡ç­¾å·²æŠ¥åºŸ";
          isRunning = false;
          return;
        }
        writeCount++;
        counterEl.textContent = writeCount;
      }

      // å¼€å§‹å¾ªç¯ï¼šäº¤æ›¿å†™å…¥ "1" å’Œ "2"
      while (isRunning && writeCount < MAX_COUNT) {
        const textToWrite = writeCount % 2 === 1 ? "2" : "1";

        statusEl.textContent = `ğŸ”„ æ­£åœ¨å†™å…¥ "${textToWrite}"...ï¼ˆç¬¬ ${writeCount + 1} æ¬¡ï¼‰`;

        const success = await writeToTag(textToWrite);
        if (!success) {
          statusEl.textContent = "âŒ æ ‡ç­¾å·²æŠ¥åºŸ";
          isRunning = false;
          return;
        }

        writeCount++;
        counterEl.textContent = writeCount;

        // é¿å…è¿‡å¿«è°ƒç”¨ï¼Œé˜²æ­¢æµè§ˆå™¨å¡é¡¿
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      if (writeCount >= MAX_COUNT) {
        statusEl.textContent = "âœ… å·²å®Œæˆå…¨éƒ¨å†™å…¥ä»»åŠ¡ï¼";
        isRunning = false;
      }
    }

    startBtn.addEventListener("click", async () => {
      if (isRunning) return;

      // è¯·æ±‚ NFC æƒé™ï¼ˆé€šè¿‡å°è¯•å†™å…¥ç©ºå†…å®¹ï¼‰
      try {
        const testWriter = new NDEFWriter();
        await testWriter.write({ records: [] });
      } catch (err) {
        statusEl.textContent = "âŒ æ— æ³•è®¿é—® NFCï¼Œè¯·æ£€æŸ¥æƒé™æˆ–è®¾å¤‡æ”¯æŒ";
        return;
      }

      writeCount = 0;
      isRunning = true;
      counterEl.textContent = "0";
      startBtn.disabled = true;

      cycleWrite().finally(() => {
        startBtn.disabled = false;
      });
    });
  </script>
</body>
</html>
