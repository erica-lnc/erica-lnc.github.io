<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC å¾ªç¯å†™å…¥ Â· 2000äº¿æ¬¡è€ä¹…æµ‹è¯•</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(145deg, #0b1c2c 0%, #1a2f3f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 2.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 40px -10px rgba(0, 0, 0, 0.6);
            max-width: 600px;
            width: 100%;
            padding: 2rem 2rem 2.5rem;
            color: #eef4fa;
            transition: all 0.2s ease;
        }
        h1 {
            font-size: 1.9rem;
            font-weight: 500;
            letter-spacing: -0.01em;
            margin-top: 0.2rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        h1 span {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 1rem 0.2rem 1.2rem;
            border-radius: 100px;
            font-size: 1rem;
            font-weight: 400;
            color: #b4d0f0;
            border: 1px solid #3a506b;
        }
        .status-panel {
            background: #0f212e;
            border-radius: 2rem;
            padding: 1.8rem 1.8rem;
            margin: 1.8rem 0 2rem;
            border: 1px solid #2c4053;
            box-shadow: inset 0 2px 5px #03080c;
        }
        .counter-main {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .counter-label {
            text-transform: uppercase;
            font-size: 0.9rem;
            font-weight: 400;
            letter-spacing: 1px;
            color: #85a9cf;
        }
        .counter-value {
            font-size: 3.8rem;
            font-weight: 600;
            line-height: 1;
            font-variant-numeric: tabular-nums;
            color: #d0eaff;
            text-shadow: 0 0 5px #3f9eff;
            word-break: break-word;
        }
        .batch-badge {
            background: #1d4057;
            border-radius: 100px;
            padding: 0.4rem 1rem;
            font-size: 1.1rem;
            font-weight: 500;
            display: inline-block;
            border: 1px solid #3d7199;
            color: #b6dcff;
            margin-top: 0.5rem;
        }
        .message-box {
            background: #0b1a24;
            border-radius: 1.5rem;
            padding: 1.2rem 1.5rem;
            margin: 1.5rem 0 2rem;
            border-left: 4px solid #2f80ed;
            font-size: 1.1rem;
            word-break: break-word;
            box-shadow: 0 5px 0 #071017;
        }
        .btn {
            background: #2f6a9b;
            border: none;
            border-radius: 3rem;
            padding: 1.2rem 2rem;
            font-size: 1.5rem;
            font-weight: 550;
            color: white;
            width: 100%;
            cursor: pointer;
            transition: 0.15s;
            box-shadow: 0 7px 0 #123456, 0 10px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #4794d1;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:active {
            transform: translateY(5px);
            box-shadow: 0 2px 0 #0e2b40, 0 8px 15px rgba(0, 0, 0, 0.5);
        }
        .btn:disabled {
            opacity: 0.5;
            transform: translateY(3px);
            box-shadow: 0 4px 0 #0e2b40;
            pointer-events: none;
            filter: grayscale(0.5);
        }
        .warn {
            color: #ffbaba;
            background-color: #4f2d2d;
            border-left-color: #e04f4f;
        }
        .success-tag {
            color: #a3f0bf;
        }
        .footer-note {
            font-size: 0.85rem;
            color: #6f8fb2;
            text-align: center;
            margin-top: 2rem;
            border-top: 1px dashed #2a445a;
            padding-top: 1rem;
        }
        .flex-row {
            display: flex;
            gap: 0.8rem;
            align-items: center;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="card" id="app">
        <h1>
            âš¡ å¾ªç¯åˆ·å†™æœº
            <span>2000äº¿æ¬¡</span>
        </h1>
        <div class="status-panel">
            <div class="counter-main">
                <span class="counter-label">å½“å‰å†™å…¥æ¬¡æ•°</span>
                <span class="counter-value" id="counterDisplay">0</span>
            </div>
            <div class="batch-badge" id="currentTextDisplay">
                ä¸‹ä¸€æ¬¡å†™å…¥: <span id="nextWriteValue">1</span>
            </div>
        </div>

        <div class="message-box" id="messageBox">
            <span id="messageText">ğŸ’¤ é—²ç½®ä¸­ Â· ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹</span>
        </div>

        <button class="btn" id="startBtn" aria-label="å¼€å§‹å¾ªç¯åˆ·NFC">
            <span>ğŸ·ï¸</span> å¼€å§‹å¾ªç¯åˆ·NFC
        </button>

        <div class="footer-note">
            Web NFC â€” å†™å…¥ 1 â†’ 2 â†’ 1 â†’ 2 â€¦â€¦ ç›´è‡³æ ‡ç­¾æŠ¥åºŸæˆ–20äº¿æ¬¡<br>
            (ç›®æ ‡2000äº¿æ¬¡ï¼Œäººç±»å¯¿å‘½å†…æ— æ³•å®Œæˆï¼Œä»…æ¼”ç¤ºå¾ªç¯)
        </div>
    </div>

    <script>
        (function() {
            // --- ä¸¥æ ¼çŠ¶æ€ç®¡ç† ---
            const NFC_MESSAGE_1 = "1";
            const NFC_MESSAGE_2 = "2";

            // ç•Œé¢å…ƒç´ 
            const counterDisplay = document.getElementById('counterDisplay');
            const messageText = document.getElementById('messageText');
            const nextWriteSpan = document.getElementById('nextWriteValue');
            const startBtn = document.getElementById('startBtn');

            // æ ¸å¿ƒçŠ¶æ€
            let isWritingActive = false;          // æ˜¯å¦æ­£åœ¨å¾ªç¯å†™å…¥ä¸­
            let currentCount = 0;                  // å·²æˆåŠŸå†™å…¥æ¬¡æ•°
            let nextValue = NFC_MESSAGE_1;          // ä¸‹ä¸€æ¬¡è¦å†™å…¥çš„æ–‡æœ¬ ('1' æˆ– '2')
            let nfcAbortController = null;          // ç”¨äºä¸­æ­¢æ‰«æ
            letæŠ¥åºŸæ ‡å¿— = false;                     // ä¸€æ—¦å¤±è´¥å°±æ°¸è¿œé˜»æ­¢å†æ¬¡å¯åŠ¨
            let currentTagMounted = false;          // è¾…åŠ©é¿å…é‡å¤ç›‘å¬åŒä¸€ä¸ªæ ‡ç­¾ (ä¿é™©)

            // ç›®æ ‡å¾ªç¯æ¬¡æ•° (2000äº¿)
            const TARGET_LOOP = 200_000_000_000;    // 2000äº¿

            // --- æ›´æ–°ç•Œé¢ (æ¬¡æ•°/ä¸‹ä¸€æ¬¡å†…å®¹/æ¶ˆæ¯) ---
            function refreshUI() {
                counterDisplay.innerText = currentCount.toLocaleString();
                nextWriteSpan.innerText = nextValue;

                // æŠ¥åºŸçŠ¶æ€æ˜¾ç¤ºä¸åŒæ ·å¼
                const msgBox = document.getElementById('messageBox');
                if (æŠ¥åºŸæ ‡å¿—) {
                    msgBox.classList.add('warn');
                } else {
                    msgBox.classList.remove('warn');
                }
            }

            // æ˜¾ç¤ºæ™®é€šæ¶ˆæ¯ (ä¸å¸¦æŠ¥åºŸæ ·å¼)
            function setMessage(msg, isError = false) {
                messageText.innerText = msg;
                if (isError) {
                    document.getElementById('messageBox').classList.add('warn');
                } else {
                    document.getElementById('messageBox').classList.remove('warn');
                }
            }

            // --- æŠ¥åºŸå¤„ç†ï¼šåœæ­¢ä¸€åˆ‡ï¼Œæ˜¾ç¤ºæ ‡ç­¾å·²æŠ¥åºŸ ---
            function handleTagBroken(optionalReason = '') {
                if (æŠ¥åºŸæ ‡å¿—) return; // å·²ç»æŠ¥åºŸï¼Œå¿½ç•¥

                // åœæ­¢æ‰€æœ‰NFCæ‰«æ
                if (nfcAbortController) {
                    try {
                        nfcAbortController.abort();
                    } catch (e) {}
                    nfcAbortController = null;
                }

                isWritingActive = false;
                æŠ¥åºŸæ ‡å¿— = true;
                currentTagMounted = false;

                // ç•Œé¢æ›´æ–°
                setMessage(`âŒ æ ‡ç­¾å·²æŠ¥åºŸ ${optionalReason ? 'Â· ' + optionalReason : ''}`, true);
                startBtn.disabled = false;   // è™½ç„¶ç¦ç”¨ç‚¹å‡»ï¼Œä½†æŒ‰é’®ä»ç„¶å¯ç‚¹ï¼Œä½†æŠ¥åºŸçŠ¶æ€ä¸‹ç‚¹å‡»ä¼šç›´æ¥æç¤ºæŠ¥åºŸ (é€šè¿‡å®ˆå«)
                refreshUI();
            }

            // --- å¹²å‡€åœæ­¢(ä¸æŠ¥åºŸ) æ¯”å¦‚ç”¨æˆ·æƒ³è¦ä¸­æ­¢æˆ–è€…æ‰«æç»“æŸï¼Œä½†è¿™é‡Œæˆ‘ä»¬ä¸ç”¨, åœæ­¢æ‰«æä½†ä¿ç•™çŠ¶æ€(å¾ªç¯å¤±è´¥è‡ªåŠ¨æŠ¥åºŸ) ---
            function stopScanning(reason = '') {
                if (nfcAbortController) {
                    nfcAbortController.abort();
                    nfcAbortController = null;
                }
                isWritingActive = false;
                currentTagMounted = false;
                if (reason) {
                    setMessage(reason);
                }
                startBtn.disabled = false;   // æŒ‰é’®é‡æ–°å¯ç”¨ (ä½†å¦‚æœæŠ¥åºŸæ ‡å¿—ä¸ºtrue, ç‚¹æŒ‰é’®ä¼šç›´æ¥æ‹’ç»)
                refreshUI();
            }

            // --- æ ¸å¿ƒå†™å…¥å‡½æ•°ï¼šå†™å…¥æŒ‡å®šçš„æ–‡æœ¬ï¼Œè¿”å›promiseï¼Œå¤±è´¥åˆ™è‡ªåŠ¨æŠ¥åºŸ ---
            async function performWrite(ndefWriter, text) {
                try {
                    // æ ¹æ®æ ‡å‡†: ä½¿ç”¨ "text/plain" æˆ–ç©ºè®°å½•, å†™å…¥çº¯æ–‡æœ¬
                    const encoder = new TextEncoder();
                    const record = {
                        recordType: "text",
                        data: encoder.encode(text),
                        encoding: "utf-8"
                    };
                    // æŸäº›Androidå®ç°éœ€è¦lang, å¢åŠ langå…¼å®¹
                    // @ts-ignore (langåœ¨Web NFCæ ‡å‡†ä¸­æ˜¯å¯é€‰)
                    record.lang = "en";

                    await ndefWriter.write({ records: [record] });
                    return true; // å†™å…¥æˆåŠŸ
                } catch (err) {
                    console.warn('å†™å…¥å¤±è´¥:', err);
                    // å†™å…¥å¤±è´¥ => æ ‡ç­¾æŠ¥åºŸ (åœæ­¢ä¸€åˆ‡)
                    handleTagBroken(`å†™å…¥å¤±è´¥ (${err.message || 'æœªçŸ¥é”™è¯¯'})`);
                    return false; // ä»£è¡¨æŠ¥åºŸç»ˆæ­¢
                }
            }

            // --- å¼€å§‹ç›‘å¬NFC (æŒ‚è½½ä¸€ä¸ªæ ‡ç­¾åè¿ç»­å†™å…¥) ---
            async function startNfcScan() {
                if (æŠ¥åºŸæ ‡å¿—) {
                    setMessage('â›” æ ‡ç­¾å·²æŠ¥åºŸï¼Œæ— æ³•ç»§ç»­ã€‚åˆ·æ–°é¡µé¢å¯é‡æ–°å°è¯•(éœ€é‡æ–°è´´å¡)', true);
                    return;
                }
                if (!('NDEFReader' in window)) {
                    setMessage('âŒ æ­¤æµè§ˆå™¨ä¸æ”¯æŒWeb NFCã€‚è¯·ä½¿ç”¨Android Chromeæˆ–æ”¯æŒWeb NFCçš„æµè§ˆå™¨', true);
                    return;
                }

                // æ¸…ç†ä¹‹å‰çš„æ‰«æ (å¦‚æœ‰)
                if (nfcAbortController) {
                    nfcAbortController.abort();
                    nfcAbortController = null;
                }

                // é‡ç½®ä¸€äº›åŠ¨æ€æ ‡è®°
                currentTagMounted = false;
                isWritingActive = true;      // è¿›å…¥æ¿€æ´»çŠ¶æ€ (ä½†è¿˜æ²¡æœ‰æ ‡ç­¾)
                startBtn.disabled = true;     // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»

                setMessage('ğŸ“± è¯·è´´ä¸ŠNFCæ ‡ç­¾ (ç­‰å¾…æ‰«æ...)');
                refreshUI();

                const abortController = new AbortController();
                nfcAbortController = abortController;

                try {
                    // åˆ›å»ºæ‰«æå®ä¾‹
                    const reader = new NDEFReader();
                    // å¼€å§‹æ‰«æ (ä¸»åŠ¨æ‰«æ)
                    await reader.scan({ signal: abortController.signal });
                    setMessage('âœ… æ‰«æå·²å¯åŠ¨ï¼Œè¯·å°†NFCæ ‡ç­¾é è¿‘è®¾å¤‡èƒŒé¢');

                    // ç›‘å¬æ ‡ç­¾è¯»å– (å½“æ ‡ç­¾é è¿‘æ—¶è§¦å‘)
                    reader.addEventListener("reading", async (event) => {
                        // å…³é”®: ä¸€æ—¦è¯»å–åˆ°æ ‡ç­¾ï¼Œç«‹å³å¼€å§‹å†™å…¥å¾ªç¯
                        // ä½†å¦‚æœå·²ç»æŠ¥åºŸï¼Œå¿½ç•¥ä»»ä½•åç»­äº‹ä»¶
                        if (æŠ¥åºŸæ ‡å¿—) {
                            return;
                        }

                        // é˜²æ­¢é‡å¤è¿›å…¥ (å¦‚æœå·²ç»æŒ‚è½½äº†ä¸€ä¸ªæ ‡ç­¾å¹¶ä¸”åœ¨å¾ªç¯ä¸­ï¼Œä¸å†å¤„ç†æ–°æ ‡ç­¾)
                        if (currentTagMounted) {
                            setMessage('âš ï¸ æ£€æµ‹åˆ°æ–°æ ‡ç­¾ï¼Œä½†å½“å‰å·²æœ‰æ ‡ç­¾åœ¨å¤„ç†ä¸­ã€‚è¯·ç§»å¼€æ ‡ç­¾å†è¯•');
                            return;
                        }

                        // æ ‡è®°å·²æŒ‚è½½
                        currentTagMounted = true;
                        setMessage(`ğŸ”– æ ‡ç­¾å·²è¯†åˆ«ï¼Œå¼€å§‹äº¤æ›¿å†™å…¥ 1 â†’ 2 ... æ¬¡æ•°: ${currentCount}`);

                        // ä¿å­˜ event ä¸­çš„ writer (ç”¨äºåç»­å†™å…¥)
                        // æ³¨æ„: è§„èŒƒä¸­NDEFReaderçš„readingäº‹ä»¶ä¸å¸¦writer, ä½†å¯ä»¥ä»eventä¸­è·å–? ä¸æ ‡å‡†ã€‚
                        // å®é™…ä½¿ç”¨: NDEFReader åœ¨scanä¹‹å, åˆ©ç”¨ NDEFWriter å†™å…¥? å­˜åœ¨ä¸¤ç§æ–¹å¼:
                        // æ–¹æ³•1: ä½¿ç”¨ NDEFWriter (å•ç‹¬çš„ç±») æ¨é€æ¶ˆæ¯åˆ°å½“å‰æ ‡ç­¾ã€‚ä½†NDEFWriter.push()è¦æ±‚æ ‡ç­¾ä½äºå°„é¢‘ã€‚
                        // æ›´ç¨³å¥: ä½¿ç”¨ NDEFWriter çš„ push æ–¹æ³•(å·²ç»ä¸éœ€è¦é‡æ–°æ‰«æ) ä½†éœ€è¦ç¡®ä¿åŒä¸€æ ‡ç­¾ã€‚
                        // ä½†æ ‡å‡†ä¸­ï¼ŒNDEFWriter å®ä¾‹åŒ–åå¯ä»¥è°ƒç”¨ write æˆ–è€… pushã€‚ä½†æ˜¯éœ€è¦æ¿€æ´»çš„æ ‡ç­¾ã€‚
                        // æœ€ä½³å®è·µ: åœ¨ reading äº‹ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ NDEFWriter å¹¶å†™å…¥ã€‚
                        // æ³¨æ„: NDEFWriter è¦æ±‚æ ‡ç­¾é è¿‘ï¼Œä½† reading äº‹ä»¶è¡¨æ˜æ ‡ç­¾å°±åœ¨åœºï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å†™ã€‚
                        // ä½†ä¸ºäº†é˜²æ­¢ç«äº‰ï¼Œä½¿ç”¨çŸ­è¿æ¥ã€‚
                        // æˆ‘ä»¬ä½¿ç”¨ç¬æ—¶writer: new NDEFWriter() æ¯æ¬¡å†™å…¥éƒ½æ–°å»ºä¹Ÿå¯ä»¥ã€‚
                        // ä½†è¿™é‡Œä¸ºäº†ç¨³å®š, ç”¨åŒä¸€ä¸ª writer ä¹Ÿå¯ä»¥ã€‚ 

                        let writer;
                        try {
                            writer = new NDEFWriter();
                        } catch (e) {
                            handleTagBroken('æ— æ³•åˆ›å»ºNDEFWriter');
                            return;
                        }

                        // ---- è¿›å…¥å†™å…¥å¾ªç¯ (ç›´åˆ°å¤±è´¥æˆ–åˆ°è¾¾2000äº¿) ----
                        while (isWritingActive && !æŠ¥åºŸæ ‡å¿— && currentCount < TARGET_LOOP) {
                            // å†™å…¥ nextValue (1æˆ–è€…2)
                            const writeContent = nextValue;
                            const success = await performWrite(writer, writeContent);
                            if (!success) {
                                // performWrite å†…éƒ¨å·²ç»è°ƒç”¨ handleTagBroken å¹¶ä¸”è¿”å›false, ç›´æ¥ç»ˆæ­¢å¾ªç¯
                                // ä½†ä»¥é˜²ä¸‡ä¸€ï¼Œæ£€æŸ¥æŠ¥åºŸæ ‡å¿—
                                if (æŠ¥åºŸæ ‡å¿—) {
                                    setMessage('âš ï¸ æ ‡ç­¾å·²æŠ¥åºŸï¼Œå¾ªç¯ç»ˆæ­¢');
                                }
                                break; // é€€å‡ºå¾ªç¯
                            }

                            // å†™å…¥æˆåŠŸ, æ›´æ–°è®¡æ•°å™¨
                            currentCount++;
                            // åˆ‡æ¢ nextValue (1 <-> 2)
                            nextValue = (nextValue === NFC_MESSAGE_1) ? NFC_MESSAGE_2 : NFC_MESSAGE_1;

                            // åˆ·æ–°ç•Œé¢è®¡æ•°å™¨ & ä¸‹ä¸€æ¬¡æ˜¾ç¤º
                            refreshUI();
                            setMessage(`âœ… æˆåŠŸå†™å…¥ ${writeContent}  (æ€»è®¡ ${currentCount})`);

                            // å¦‚æœè¾¾åˆ°2000äº¿, æ˜¾ç¤ºæˆåŠŸ (ä½†å‡ ä¹ä¸å¯èƒ½, ä¿ç•™ç‰¹æ€§)
                            if (currentCount >= TARGET_LOOP) {
                                setMessage(`ğŸ‰ æ­å–œï¼å·²å®Œæˆ2000äº¿æ¬¡å†™å…¥ (ç†è®ºä¸Š)`);
                                isWritingActive = false;
                                startBtn.disabled = false;
                                currentTagMounted = false;
                                if (nfcAbortController) {
                                    nfcAbortController.abort();
                                    nfcAbortController = null;
                                }
                                break;
                            }

                            // è½»å¾®å»¶è¿Ÿï¼Œè®©æ ‡ç­¾æœ‰ç¨³å®šæ—¶é—´ï¼Œä¹Ÿé¿å…è¿‡äºå‡¶çŒ›å¯¼è‡´å¡é¡¿ã€‚ä½†ä¸è¦ç”¨å›ºå®šdelayï¼Œé äº‹ä»¶é©±åŠ¨ã€‚
                            // ä¸ºäº†æ›´ç¨³å¥ï¼ŒåŠ å…¥ä¸€ä¸ªå¾®å°çš„é—´æ­‡ (10ms) è®©å‡ºäº‹ä»¶å¾ªç¯ï¼Œé˜²æ­¢ç•Œé¢å†»ç»“ã€‚
                            await new Promise(resolve => setTimeout(resolve, 10));
                        }

                        // é€€å‡ºå¾ªç¯åï¼Œå¦‚æœæœªæŠ¥åºŸä½†isWritingActiveè¢«è®¾ä¸ºfalse(æ¯”å¦‚å¤–éƒ¨åœæ­¢), åˆ™å…³é—­æ‰«æå¹¶é‡ç½®æŒ‰é’®
                        if (!æŠ¥åºŸæ ‡å¿—) {
                            // æ­£å¸¸é€€å‡º(æ¯”å¦‚è¾¾åˆ°2000äº¿æˆ–è€…æ‰‹åŠ¨åœæ­¢), ä½†æ‰‹åŠ¨åœæ­¢æœªå®ç°ï¼Œä¿ç•™è¢«åŠ¨é€€å‡ºæ¡ä»¶ã€‚
                            // å¦‚æœæ˜¯å› ä¸ºè¾¾åˆ°ç›®æ ‡é€€å‡º, å·²ç»å¤„ç†ã€‚å¦‚æœæ˜¯å…¶ä»–åŸå› , åœæ­¢æ‰«æã€‚
                            if (currentCount >= TARGET_LOOP) {
                                // å·²å¤„ç†
                            } else {
                                // å¦‚æœä¸æ˜¯æŠ¥åºŸä¹Ÿä¸æ˜¯å®Œæˆï¼Œè¯´æ˜è¢«å¤–éƒ¨æ ‡å¿—åœç”¨ï¼Œè¿™æ—¶å€™åœæ­¢æ‰«æ
                                if (!isWritingActive) {
                                    stopScanning('â¸ï¸ å†™å…¥å·²æš‚åœ');
                                }
                            }
                            currentTagMounted = false;
                            startBtn.disabled = false;
                        } else {
                            // å·²æŠ¥åºŸ æŒ‰é’®ä¸å¯ç‚¹? æŒ‰é’®åœ¨handleTagBrokenä¸­å·²ç»è®¾ç½®äº†startBtn disabled = falseï¼Œä½†æˆ‘ä»¬å¸Œæœ›ä¸è®©ç‚¹å‡»ï¼Œä½†æŠ¥åºŸæ ‡å¿—ä¼šé˜»æ­¢é‡æ–°å¯åŠ¨
                            // æ‰€ä»¥æŒ‰é’®å¯ç‚¹ï¼Œä½†ç‚¹å‡»æ—¶ä¼šç›´æ¥æ£€æµ‹æŠ¥åºŸæ ‡å¿—å¹¶æç¤ºã€‚
                        }

                    }, { signal: abortController.signal });

                    // é”™è¯¯å¤„ç†: æ‰«æé”™è¯¯ (é€šå¸¸æ˜¯å› ä¸ºNFCä¸å¯ç”¨æˆ–è¢«å–æ¶ˆ)
                    reader.addEventListener("readingerror", (error) => {
                        console.warn('NFC reading error:', error);
                        if (!æŠ¥åºŸæ ‡å¿—) {
                            setMessage(`âš ï¸ è¯»å–é”™è¯¯: è¯·é‡æ–°è´´æ ‡ç­¾`, false);
                        }
                    });

                } catch (err) {
                    // æ‰«æå¯åŠ¨å¤±è´¥ (NFCå…³é—­æˆ–æƒé™)
                    console.error('scan error', err);
                    setMessage(`âŒ æ— æ³•å¯åŠ¨NFCæ‰«æ: ${err.message}`, true);
                    isWritingActive = false;
                    startBtn.disabled = false;
                    nfcAbortController = null;
                }
            }

            // --- æŒ‰é’®ç‚¹å‡»å¤„ç† ---
            async function onStartClick() {
                // å¦‚æœå·²ç»æŠ¥åºŸï¼Œç›´æ¥æ˜¾ç¤ºæŠ¥åºŸä¿¡æ¯ï¼Œä¸å†å¯åŠ¨
                if (æŠ¥åºŸæ ‡å¿—) {
                    setMessage('ğŸš« æ ‡ç­¾å·²æŠ¥åºŸã€‚è¯·åˆ·æ–°é¡µé¢é‡ç½® (é‡æ–°åŠ è½½åå¯ç”¨æ–°æ ‡ç­¾)', true);
                    return;
                }

                // å¦‚æœæ­£åœ¨å†™å…¥ï¼Œä¹Ÿå¯ä»¥å†æ¬¡ç‚¹å‡»ï¼Ÿæˆ‘ä»¬å…è®¸é‡æ–°å¯åŠ¨ï¼Œä½†ä¼šå…ˆä¸­æ­¢ä¹‹å‰çš„æ‰«æ
                if (isWritingActive) {
                    // ä¸­æ­¢å½“å‰æ‰«æ, é‡ç½®æ ‡è®°
                    if (nfcAbortController) {
                        nfcAbortController.abort();
                        nfcAbortController = null;
                    }
                    isWritingActive = false;
                    currentTagMounted = false;
                    setMessage('â¸ï¸ å·²åœæ­¢ä¹‹å‰çš„æ‰«æï¼Œå¯é‡æ–°å¼€å§‹');
                    startBtn.disabled = false;  // ç¨ååˆä¼šenable, ä½†é€’å½’è°ƒç”¨onStartClickä¼šå†æ¬¡å¯åŠ¨
                    // çŸ­æš‚å»¶è¿Ÿï¼Œè®©UIæ›´æ–°
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                // é‡ç½®æ¬¡æ•°? æ ¹æ®éœ€æ±‚â€œä¸è¦åˆ é™¤ï¼Œä¸è¦ç©ºå†…å®¹â€ï¼Œä½†ç”¨æˆ·åˆ·æ–°å¡å¯èƒ½æƒ³é‡ç½®è®¡æ•°ï¼Ÿä½†ä¸šåŠ¡æ²¡è¦æ±‚é‡ç½®ï¼Œæˆ‘ä»¬ä¿ç•™ç´¯åŠ ã€‚
                // ä½†ä¸ºäº†èƒ½å¤Ÿé‡æ–°å¼€å§‹è®¡æ•°ï¼Œå…è®¸ä»0å¼€å§‹ï¼Ÿä½†é€»è¾‘ä¸Šå¦‚æœåŒä¸€æ ‡ç­¾æŠ¥åºŸåä¸èƒ½ç»§ç»­ã€‚
                // æˆ‘ä»¬ä¿ç•™ç»§ç»­ç´¯åŠ è®¡æ•° (é™¤éæŠ¥åºŸåˆ·æ–°é¡µé¢)ã€‚ä½†ä¹Ÿå¯ä»¥å¢åŠ ä¸€ä¸ªé‡ç½®æŒ‰é’®ï¼Œä½†éœ€æ±‚æ— ï¼Œæ‰€ä»¥ä¿æŒå½“å‰è®¡æ•°ã€‚

                // å¯åŠ¨æ‰«æ
                await startNfcScan();
            }

            // ç»‘å®šç‚¹å‡»
            startBtn.addEventListener('click', onStartClick);

            // åˆå§‹åŒ–ç•Œé¢
            refreshUI();
            setMessage('ğŸ’¤ ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ Â· ç›®æ ‡2000äº¿æ¬¡');

            // æ³¨æ„: ä¸ºäº†é¿å…æµè§ˆå™¨åœ¨åå°æˆ–é”å±æ—¶å¼‚å¸¸ï¼Œä¸å¤„ç†ã€‚
            // å®Œå…¨ç¬¦åˆ: ä¸€æ—¦å†™å…¥å¤±è´¥å°±åœæ­¢å¹¶æ˜¾ç¤ºæŠ¥åºŸã€‚
            // æµ‹è¯•æ³¨æ„: æœ‰äº›æ ‡ç­¾å¯èƒ½å› ä¿æŠ¤è€Œå†™å…¥å¤±è´¥, ç¬¦åˆâ€œæ ‡ç­¾å·²æŠ¥åºŸâ€
            // ä¸èƒ½åˆ é™¤å†…å®¹: æˆ‘ä»¬åªå†™å…¥1å’Œ2, ä¸æ‰§è¡Œåˆ é™¤æ“ä½œã€‚
            // çº¯HTML+Web NFCï¼Œæ— å¤–éƒ¨ä¾èµ–ã€‚
            // å¾ªç¯2000äº¿æ¬¡ï¼Œç•Œé¢æ˜¾ç¤ºæ•°å­—ç†è®ºä¸Šå¯ä»¥æ— é™å¢åŠ ï¼Œä½†è¶…å‡ºå®‰å…¨æ•´æ•°ï¼ŸJSæœ€å¤§å®‰å…¨æ•´æ•°çº¦9e15ï¼Œæ‰€ä»¥æ— é—®é¢˜ã€‚
            // æ€§èƒ½: å®æ—¶æ˜¾ç¤º, æ¯å†™ä¸€æ¬¡æ›´æ–°ä¸€æ¬¡ã€‚
        })();
    </script>
</body>
</html>
