<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>香港中學面試評分系統 | 純前端離線版</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "SimSun", "微軟正黑體", "細明體", Arial, sans-serif; }
    body { background: #f0f2f5; padding: 15px; line-height: 1.6; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 25px; }
    .header { text-align: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
    .header h1 { color: #165DFF; font-size: 24px; margin-bottom: 8px; }
    .header p { color: #666; font-size: 14px; }
    .tab-nav { display: flex; justify-content: center; gap: 12px; margin-bottom: 25px; }
    .tab-btn { padding: 10px 22px; border: none; border-radius: 100px; background: #f5f7fa; color: #333; font-size: 15px; cursor: pointer; transition: all 0.3s; }
    .tab-btn.active { background: #165DFF; color: #fff; }
    .card { background: #fafbfc; border-radius: 16px; padding: 20px; margin-bottom: 20px; }
    .card h3 { color: #165DFF; font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
    .card h3::before { content: ""; width: 4px; height: 16px; background: #165DFF; border-radius: 2px; }
    .card .tip { color: #666; font-size: 14px; margin-bottom: 15px; }
    .btn-group { display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #165DFF; color: #fff; }
    .btn-success { background: #00B42A; color: #fff; }
    .btn-danger { background: #F53F3F; color: #fff; }
    .btn:disabled { background: #e5e7eb; color: #999; cursor: not-allowed; }
    .text-area { width: 100%; height: 120px; padding: 15px; border: 1px solid #eee; border-radius: 10px; font-size: 14px; resize: none; margin: 10px 0; background: #fff; }
    .article-box { width: 100%; min-height: 100px; padding: 15px; border: 1px solid #eee; border-radius: 10px; font-size: 14px; background: #fff; margin: 10px 0; line-height: 1.8; color: #333; }
    .score-card { text-align: center; padding: 20px; border-radius: 16px; background: linear-gradient(135deg, #e8f4ff 0%, #f0f7ff 100%); margin: 15px 0; }
    .score-num { font-size: 50px; font-weight: 700; color: #F53F3F; margin: 10px 0; }
    .score-desc { color: #666; font-size: 14px; line-height: 1.5; }
    .status { font-size: 13px; margin-top: 10px; padding: 8px; border-radius: 6px; }
    .status-success { color: #00B42A; background: #e8fdf0; }
    .status-loading { color: #165DFF; background: #e8f4ff; }
    .status-error { color: #F53F3F; background: #feeef0; }
    .hide { display: none !important; }
    @media (max-width: 500px) {
      .container { padding: 15px; }
      .header h1 { font-size: 20px; }
      .score-num { font-size: 36px; }
      .tab-btn, .btn { padding: 8px 15px; font-size: 13px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>香港中學面試評分系統 | 純前端離線版</h1>
      <p>語音轉文字·繁體詞庫匹配打分·文章朗讀糾錯 | 支持粵語/普通話</p>
    </div>

    <div class="tab-nav">
      <button class="tab-btn active" id="tab-intro" onclick="switchTab('intro')">自我介紹打分</button>
      <button class="tab-btn" id="tab-article" onclick="switchTab('article')">朗讀文章糾錯</button>
    </div>

    <div id="content-intro">
      <div class="card">
        <h3>自我介紹語音錄入</h3>
        <p class="tip">點擊錄製按鈕，說出你的自我介紹（支持粵語/普通話），停止後自動轉文字並打分</p>
        <div class="btn-group">
          <button class="btn btn-primary" id="start-intro" onclick="startRecord('intro')">開始錄製</button>
          <button class="btn btn-danger" id="stop-intro" onclick="stopRecord('intro')" disabled>停止錄製</button>
        </div>
        <textarea class="text-area" id="intro-text" placeholder="錄製的文字將顯示在這裡..."></textarea>
        <div class="score-card">
          <div>本次自我介紹得分</div>
          <div class="score-num" id="intro-score">0</div>
          <div class="score-desc">匹配核心詞：<span id="intro-match">0</span> / 總核心詞：<span id="intro-total-key">103</span> | 匹配度：<span id="intro-rate">0%</span></div>
        </div>
        <div class="status" id="intro-status"></div>
      </div>
    </div>

    <div id="content-article" class="hide">
      <div class="card">
        <h3>隨機獲取朗讀文章</h3>
        <p class="tip">點擊獲取後隨機生成1篇文章，朗讀錄製後自動對比糾錯打分</p>
        <div class="btn-group">
          <button class="btn btn-success" id="get-article" onclick="getRandomArticle()">獲取隨機文章</button>
          <button class="btn btn-primary" id="start-article" onclick="startRecord('article')" disabled>開始朗讀錄製</button>
          <button class="btn btn-danger" id="stop-article" onclick="stopRecord('article')" disabled>停止錄製</button>
        </div>
        <div class="article-box" id="article-content">請點擊上方按鈕獲取隨機文章</div>
        <div class="status" id="article-get-status"></div>
      </div>
      <div class="card">
        <h3>你的朗讀文字</h3>
        <textarea class="text-area" id="article-text" placeholder="錄製的朗讀文字將顯示在這裡..."></textarea>
        <div class="score-card">
          <div>本次朗讀糾錯得分</div>
          <div class="score-num" id="article-score">0</div>
          <div class="score-desc">錯字/漏字：<span id="article-error">0</span> | 文章總字數：<span id="article-total-word">0</span> | 正確率：<span id="article-rate">0%</span></div>
        </div>
        <div class="status" id="article-score-status"></div>
      </div>
    </div>
  </div>

  <script>
    const globalConfig = {
      currentTab: 'intro',
      isRecording: false,
      mediaRecorder: null,
      currentArticle: null
    };

    // 核心詞庫：香港中學面試繁體中文103個（分類整合，去重精準）
    const keywordDB = [
      // 性格特徵描述
      "開朗活潑", "主動積極", "熱情自信", "具責任感", "有毅力", "面對困難", "謙虛有禮", "樂於助人", "擅長團隊合作", "具適應力",
      "性格開朗", "責任心強", "堅持不懈", "勇於面對困難", "待人謙和", "禮貌待人", "熱心助人", "團隊協作", "適應能力強", "積極向上", "自信大方",
      // 學業及專長能力
      "熱愛學習", "主動求知", "語文能力強", "擅長思考", "解難能力高", "邏輯思維強", "積極參與", "課外活動", "參與比賽", "獲得獎項",
      "比賽冠軍", "比賽優異獎", "自主學習", "求知慾強", "語言能力", "邏輯能力", "思維敏捷", "解決問題", "善於思考", "學業優異",
      "專長突出", "能力過硬", "積極參與活動", "競賽獲獎", "榮獲獎項", "學習能力強", "接受能力快", "善於總結", "歸納能力", "分析能力", "應變能力", "學術能力",
      // 興趣愛好
      "熱愛運動", "游泳", "籃球", "足球", "熱衷閱讀", "享受音樂", "鋼琴", "小提琴", "繪畫創作", "編程設計",
      "閱讀書籍", "聽音樂", "樂器演奏", "美術創作", "繪畫", "程序設計", "體育鍛煉", "球類運動", "藝術創作", "數碼設計",
      // 關鍵句型結構
      "您好", "我是", "畢業於", "小學名稱", "性格開朗且具責任感", "學生", "在學校", "積極參與", "活動", "科目",
      "特別擅長", "特定能力", "我希望", "升上中學後", "繼續發展", "興趣", "能力", "學習更多新事物", "謝謝老師", "給我這次機會",
      // 亮點加分詞
      "時間管理能力強", "平衡學業與活動", "追求卓越", "學習目標", "熱衷探索", "對知識的渴求", "自我挑戰", "不畏困難", "時間管理", "學業平衡", "探索新知", "勇於挑戰"
    ];

    // 朗讀文章庫：繁體中文5篇（香港中學面試場景适配）
    const articleDB = [
      { title: "香港簡介1", content: "香港是高度繁榮的國際大都會，位於珠江口東側，是世界著名的自由貿易港，也是國際金融、貿易、航運中心。香港中西文化交融，既有現代都市的繁華，也保留著傳統的文化習俗。" },
      { title: "香港簡介2", content: "香港的經濟以服務業為主，金融、旅遊、貿易及物流是四大支柱產業。香港的教育制度完善，重視學生的綜合素質培養，鼓勵學生積極參與課外活動，全面發展。" },
      { title: "面試禮儀1", content: "面試時應提前到達考場，保持衣著整潔，言行舉止禮貌得體。回答問題時要思路清晰，表達流暢，實事求是，避免誇大其詞，同時展現出自身的自信和對學校的熱情。" },
      { title: "面試禮儀2", content: "自我介紹是面試的重要環節，應簡潔明瞭，突出個人優勢和與學校的匹配度，避免冗長無意義的表述。結束面試時，應向老師表示感謝，展現良好的禮貌和素養。" },
      { title: "學習規劃", content: "升上中學後，我希望能繼續保持熱愛學習的態度，主動探索新知識，積極參與學校的各項活動，平衡好學業與興趣，努力提升自身的綜合能力，成為一名優秀的中學生。" }
    ];

    window.onload = function() {
      document.getElementById('intro-total-key').textContent = keywordDB.length;
    };

    // 標籤頁切換
    function switchTab(tab) {
      globalConfig.currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`tab-${tab}`).classList.add('active');
      document.getElementById('content-intro').classList.toggle('hide', tab === 'article');
      document.getElementById('content-article').classList.toggle('hide', tab === 'intro');
    }

    // 語音錄製與識別（Chrome/Edge原生API，支持粵語zh-YUE/普通話zh-CN）
    function startRecord(type) {
      const startBtn = document.getElementById(`start-${type}`);
      const stopBtn = document.getElementById(`stop-${type}`);
      const status = document.getElementById(`${type}-status`);
      const speechLang = type === 'intro' ? 'zh-YUE' : 'zh-CN'; // 自我介紹默認粵語，朗讀默認普通話

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        showStatus(type, 'error', '你的瀏覽器不支持語音識別，請使用Chrome/Edge');
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = speechLang;
      recognition.continuous = false; // 關閉連續識別，避免無效語音干擾
      recognition.interimResults = false; // 只返回最終識別結果
      recognition.maxAlternatives = 1; // 只取最準確的識別結果

      recognition.onresult = (e) => {
        const text = e.results[0][0].transcript;
        document.getElementById(`${type}-text`).value = text;
        if (e.results[0].isFinal) {
          stopRecord(type, true);
          type === 'intro' ? scoreIntro(text) : scoreArticle(text);
        }
      };

      recognition.onerror = (e) => {
        showStatus(type, 'error', `語音識別失敗：${e.error}`);
        startBtn.disabled = false;
        stopBtn.disabled = true;
      };

      recognition.onend = () => {
        if (globalConfig.isRecording) recognition.start();
      };

      globalConfig.mediaRecorder = recognition;
      recognition.start();
      globalConfig.isRecording = true;

      startBtn.disabled = true;
      stopBtn.disabled = false;
      showStatus(type, 'loading', '正在錄製，請說話...');
    }

    function stopRecord(type, isAuto = false) {
      const startBtn = document.getElementById(`start-${type}`);
      const stopBtn = document.getElementById(`stop-${type}`);
      if (globalConfig.mediaRecorder && globalConfig.isRecording) {
        globalConfig.mediaRecorder.stop();
        globalConfig.isRecording = false;
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
      if (!isAuto) {
        showStatus(type, 'success', '錄製已停止');
        const text = document.getElementById(`${type}-text`).value;
        if (text) type === 'intro' ? scoreIntro(text) : scoreArticle(text);
      }
    }

    // 核心打分邏輯（BUG修復：精準匹配+文本預處理+去重）
    function scoreIntro(text) {
      // 文本預處理：去空格/標點/換行，統一格式（修復無效字符干擾）
      const cleanText = text.replace(/[^\u4e00-\u9fa5]/g, '').replace(/\s+/g, '');
      if (!cleanText) {
        showStatus('intro', 'error', '未識別到有效文字，請重新錄製');
        document.getElementById('intro-score').textContent = 0;
        document.getElementById('intro-match').textContent = 0;
        document.getElementById('intro-rate').textContent = '0%';
        return;
      }

      // 精準匹配：遍歷詞庫，完整匹配才計數，並去重（修復重複加分）
      const matchedSet = new Set();
      keywordDB.forEach(key => {
        if (cleanText.includes(key)) {
          matchedSet.add(key);
        }
      });
      const matchCount = matchedSet.size;
      const totalCount = keywordDB.length;
      const matchRate = ((matchCount / totalCount) * 100).toFixed(1);
      const finalScore = matchCount === 0 ? 0 : Math.round((matchCount / totalCount) * 100); // 無匹配得0分

      // 更新分數
      document.getElementById('intro-score').textContent = finalScore;
      document.getElementById('intro-match').textContent = matchCount;
      document.getElementById('intro-rate').textContent = `${matchRate}%`;
      showStatus('intro', 'success', `打分完成！精準匹配${matchCount}個核心詞`);
    }

    // 朗讀文章糾錯打分（逐字對比，精準計算錯字）
    function scoreArticle(text) {
      if (!globalConfig.currentArticle) {
        showStatus('article-score', 'error', '請先獲取隨機文章');
        return;
      }
      const cleanText = text.replace(/[^\u4e00-\u9fa5]/g, '').replace(/\s+/g, '');
      const cleanArticle = globalConfig.currentArticle.content.replace(/[^\u4e00-\u9fa5]/g, '').replace(/\s+/g, '');
      const totalWord = cleanArticle.length;
      if (totalWord === 0) {
        showStatus('article-score', 'error', '文章無有效文字');
        return;
      }
      if (!cleanText) {
        showStatus('article-score', 'error', '未識別到有效朗讀文字');
        document.getElementById('article-score').textContent = 0;
        document.getElementById('article-error').textContent = 0;
        document.getElementById('article-total-word').textContent = totalWord;
        document.getElementById('article-rate').textContent = '0%';
        return;
      }

      let errorCount = 0;
      for (let i = 0; i < totalWord; i++) {
        if (cleanText[i] !== cleanArticle[i]) errorCount++;
      }
      if (cleanText.length > totalWord) errorCount += cleanText.length - totalWord;
      const accuracy = Math.max(0, Math.round(((totalWord - errorCount) / totalWord) * 100));
      const accuracyRate = ((totalWord - errorCount) / totalWord * 100).toFixed(1);

      document.getElementById('article-score').textContent = accuracy;
      document.getElementById('article-error').textContent = errorCount;
      document.getElementById('article-total-word').textContent = totalWord;
      document.getElementById('article-rate').textContent = `${accuracyRate}%`;
      showStatus('article-score', 'success', `打分完成！正確率${accuracyRate}%`);
    }

    // 隨機獲取朗讀文章
    function getRandomArticle() {
      const randomIndex = Math.floor(Math.random() * articleDB.length);
      const randomArticle = articleDB[randomIndex];
      globalConfig.currentArticle = randomArticle;
      document.getElementById('article-content').textContent = randomArticle.content;
      document.getElementById('start-article').disabled = false;
      document.getElementById('article-text').value = '';
      document.getElementById('article-score').textContent = 0;
      document.getElementById('article-error').textContent = 0;
      document.getElementById('article-total-word').textContent = 0;
      document.getElementById('article-rate').textContent = '0%';
      document.getElementById('article-score-status').textContent = '';
      showStatus('article-get', 'success', `已獲取文章：${randomArticle.title}`);
    }

    // 狀態提示封裝
    function showStatus(type, statusType, msg) {
      const statusEl = document.getElementById(`${type}-status`);
      statusEl.textContent = msg;
      statusEl.className = 'status';
      statusEl.classList.add(`status-${statusType}`);
      if (statusType === 'error') {
        setTimeout(() => statusEl.textContent = '', 3000);
      }
    }
  </script>
</body>
</html>
