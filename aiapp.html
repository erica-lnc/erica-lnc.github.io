<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ å…è´¹ç¨‹åºç”Ÿæˆå™¨ âœ¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            padding: 35px;
            position: relative;
            overflow: hidden;
        }
        .container::before {
            content: "ğŸ’»";
            font-size: 120px;
            position: absolute;
            top: -20px;
            right: -20px;
            opacity: 0.05;
            transform: rotate(15deg);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #2d3748;
            font-size: 28px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        .header p {
            color: #718096;
            font-size: 14px;
        }
        .status-bar {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        .status-success {
            background-color: #e8f4f8;
            color: #4299e1;
            display: block;
        }
        .status-error {
            background-color: #fef2f2;
            color: #e53e3e;
            display: block;
        }
        .model-select-group {
            margin-bottom: 20px;
        }
        .model-select-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 16px;
        }
        .model-select-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            background-color: #fafafa;
            cursor: pointer;
        }
        .input-section {
            margin-bottom: 25px;
        }
        .input-section label {
            display: block;
            margin-bottom: 10px;
            color: #4a5568;
            font-weight: 600;
            font-size: 16px;
        }
        .input-section textarea {
            width: 100%;
            min-height: 150px;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            resize: vertical;
            transition: border-color 0.3s;
            background-color: #fafafa;
        }
        .input-section textarea:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        .btn-group {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        #generateBtn {
            background-color: #4299e1;
            color: white;
        }
        #generateBtn:hover {
            background-color: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }
        #downloadBtn {
            background-color: #48bb78;
            color: white;
            display: none;
        }
        #downloadBtn:hover {
            background-color: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }
        .result-box {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            display: none;
        }
        .result-header {
            background-color: #f7fafc;
            padding: 12px 18px;
            color: #2d3748;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .result-content {
            padding: 18px;
            background-color: #ffffff;
            max-height: 300px;
            overflow-x: auto;
        }
        .result-content pre {
            font-size: 14px;
            line-height: 1.6;
            color: #2d3748;
        }
        .status {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
        }
        .loading {
            color: #4299e1;
            display: none;
        }
        .error {
            color: #e53e3e;
            display: none;
        }
        .hint {
            color: #ed8936;
            margin-top: 10px;
            font-size: 13px;
            text-align: center;
            display: none;
        }
        .cors-tip {
            background-color: #faf0f5;
            border-left: 4px solid #ed8936;
            padding: 12px;
            margin-top: 15px;
            font-size: 12px;
            color: #4a5568;
            display: none;
        }
        @media (max-width: 600px) {
            .container {
                padding: 25px;
                margin: 20px auto;
            }
            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âœ¨ å…è´¹ç¨‹åºç”Ÿæˆå™¨ âœ¨</h1>
            <p>é€‰æ‹©æ¨¡å‹ â†’ è¾“å…¥éœ€æ±‚ â†’ ä¸€é”®ç”Ÿæˆä¸‹è½½ ğŸš€</p>
        </div>

        <div id="serverStatus" class="status-bar"></div>

        <div class="model-select-group">
            <label for="modelSelect">ğŸ¤– é€‰æ‹©å¯ç”¨æ¨¡å‹ï¼š</label>
            <select id="modelSelect" disabled>
                <option value="">åŠ è½½ä¸­...</option>
            </select>
        </div>

        <div class="input-section">
            <label for="prompt">ğŸ“ è¯·è¾“å…¥ä½ çš„ç¨‹åºéœ€æ±‚ï¼š</label>
            <textarea id="prompt" placeholder="ä¾‹å¦‚ï¼šç”Ÿæˆä¸€ä¸ªå¸¦å€’è®¡æ—¶åŠŸèƒ½çš„ç½‘é¡µï¼Œçº¯å‰ç«¯ï¼Œæ— åç«¯ä¾èµ–..."></textarea>
        </div>

        <div class="btn-group">
            <button id="generateBtn" class="btn" disabled>âš¡ ç”Ÿæˆä»£ç </button>
            <button id="downloadBtn" class="btn">ğŸ“¥ ä¸‹è½½æ–‡ä»¶</button>
        </div>

        <div class="status">
            <span class="loading" id="loading">æ­£åœ¨ç”Ÿæˆä¸­... è¯·ç¨å€™ â³</span>
            <span class="error" id="error">âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æˆ–é‡è¯•</span>
            <div class="hint" id="hint">ğŸ’¡ æç¤ºï¼š1.æ£€æŸ¥æ¥å£åœ°å€/ç«¯å£ 2.ç¡®è®¤æœåŠ¡å™¨å·²å¯åŠ¨ 3.å…³é—­é˜²ç«å¢™æ‹¦æˆª</div>
            <div class="cors-tip" id="corsTip">
                âš ï¸ è·¨åŸŸé—®é¢˜è§£å†³æ–¹æ¡ˆï¼š<br>
                1. æœåŠ¡å™¨ç«¯æ·»åŠ å“åº”å¤´ï¼šAccess-Control-Allow-Origin: * <br>
                2. æœ¬åœ°æµ‹è¯•ç”¨æµè§ˆå™¨è·¨åŸŸæ’ä»¶ï¼ˆå¦‚ Chrome çš„ Allow CORSï¼‰<br>
                3. ç”¨ Nginx åå‘ä»£ç†è½¬å‘è¯·æ±‚
            </div>
        </div>

        <div class="result-box" id="resultBox">
            <div class="result-header">
                <span>ğŸ“„ ç”Ÿæˆç»“æœ</span>
            </div>
            <div class="result-content">
                <pre id="result"></pre>
            </div>
        </div>
    </div>

    <script>
        // ==================== æ ¸å¿ƒé…ç½®åŒºåŸŸï¼ˆå¿…å¡«ï¼ï¼‰ ====================
        const SERVER_CONFIG = {
            modelListUrl: "https://free.v36.cm/v1", 
            generateUrl: "https://free.v36.cm/v1",
            apiKey: "sk-bvcnqkYbJU7C6yGwDc07E3D3F7884c10897d8dB60f185fCe",
            modelListField: "models",
            timeout: 10000 // è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼š10ç§’
        };
        // =================================================================

        const modelSelect = document.getElementById('modelSelect');
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const promptInput = document.getElementById('prompt');
        const resultBox = document.getElementById('resultBox');
        const result = document.getElementById('result');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const hint = document.getElementById('hint');
        const serverStatus = document.getElementById('serverStatus');
        const corsTip = document.getElementById('corsTip');

        // å¸¦è¶…æ—¶çš„ fetch è¯·æ±‚å°è£…
        function fetchWithTimeout(url, options = {}) {
            const { timeout = SERVER_CONFIG.timeout } = options;
            return Promise.race([
                fetch(url, options),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error(`è¯·æ±‚è¶…æ—¶ï¼ˆ>${timeout}msï¼‰`)), timeout)
                )
            ]);
        }

        window.onload = async () => {
            await fetchModelList();
        };

        async function fetchModelList() {
            try {
                const headers = {};
                if (SERVER_CONFIG.apiKey) headers['Authorization'] = `Bearer ${SERVER_CONFIG.apiKey}`;

                const response = await fetchWithTimeout(SERVER_CONFIG.modelListUrl, { headers });
                const contentType = response.headers.get('content-type');
                
                if (!response.ok) throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯ï¼š${response.status}`);
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error("æ¨¡å‹æ¥å£è¿”å›éJSONæ ¼å¼æ•°æ®");
                }

                const data = await response.json();
                const modelList = data[SERVER_CONFIG.modelListField] || [];
                
                if (modelList.length === 0) throw new Error("æœåŠ¡å™¨æ— å¯ç”¨æ¨¡å‹");

                modelSelect.innerHTML = "";
                modelList.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });

                serverStatus.className = "status-bar status-success";
                serverStatus.textContent = `âœ… æœåŠ¡å™¨è¿æ¥æˆåŠŸï¼Œå…± ${modelList.length} ä¸ªå¯ç”¨æ¨¡å‹`;
                modelSelect.disabled = false;
                generateBtn.disabled = false;
            } catch (err) {
                serverStatus.className = "status-bar status-error";
                serverStatus.textContent = `âŒ ${err.message}`;
                modelSelect.innerHTML = "<option value=''>è·å–å¤±è´¥</option>";
                // åˆ¤å®šè·¨åŸŸ/ç½‘ç»œé”™è¯¯ï¼Œæ˜¾ç¤ºä¸“å±æç¤º
                if (err.message.includes("Failed to fetch") || err.message.includes("CORS")) {
                    corsTip.style.display = "block";
                }
                hint.style.display = "block";
            }
        }

        function extractCode(text) {
            const htmlMatch = text.match(/```html([\s\S]*?)```/);
            if (htmlMatch) return htmlMatch[1].trim();
            const codeMatch = text.match(/```([\s\S]*?)```/);
            if (codeMatch) return codeMatch[1].trim();
            return text.trim();
        }

        generateBtn.addEventListener('click', async () => {
            const selectedModel = modelSelect.value;
            const prompt = promptInput.value.trim();

            if (!selectedModel || !prompt) {
                alert(selectedModel ? "è¯·è¾“å…¥éœ€æ±‚ï¼" : "è¯·é€‰æ‹©æ¨¡å‹ï¼");
                return;
            }

            loading.style.display = 'inline';
            error.style.display = 'none';
            hint.style.display = 'none';
            corsTip.style.display = 'none';
            resultBox.style.display = 'none';
            downloadBtn.style.display = 'none';

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (SERVER_CONFIG.apiKey) headers['Authorization'] = `Bearer ${SERVER_CONFIG.apiKey}`;

                const response = await fetchWithTimeout(SERVER_CONFIG.generateUrl, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        model: selectedModel,
                        prompt: `ä»…è¾“å‡ºHTML+CSS+JSä»£ç ï¼Œç”¨\`\`\`html\`\`\`åŒ…è£¹ï¼Œæ— è§£é‡Šã€‚éœ€æ±‚ï¼š${prompt}`,
                        stream: false
                    })
                });

                if (!response.ok) throw new Error(`ç”Ÿæˆè¯·æ±‚å¤±è´¥ï¼š${response.status}`);
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error("ç”Ÿæˆæ¥å£è¿”å›éJSONæ ¼å¼æ•°æ®");
                }

                const data = await response.json();
                let aiContent = data.response || data.content || data.choices?.[0]?.message?.content || "";
                
                if (!aiContent) throw new Error("æœåŠ¡å™¨æœªè¿”å›æœ‰æ•ˆä»£ç ");
                const code = extractCode(aiContent);
                if (!code) throw new Error("æœªæå–åˆ°HTMLä»£ç ");

                result.textContent = code;
                resultBox.style.display = 'block';
                downloadBtn.style.display = 'block';
                window.generatedCode = code;

            } catch (err) {
                console.error("ç”Ÿæˆå¤±è´¥è¯¦æƒ…ï¼š", err);
                error.textContent = `âŒ ç”Ÿæˆå¤±è´¥ï¼š${err.message}`;
                error.style.display = 'inline';
                hint.style.display = 'block';
                if (err.message.includes("Failed to fetch") || err.message.includes("CORS")) {
                    corsTip.style.display = "block";
                }
            } finally {
                loading.style.display = 'none';
            }
        });

        // ä¸‹è½½æ–‡ä»¶
        downloadBtn.addEventListener('click', () => {
            if (!window.generatedCode) return;
            const blob = new Blob([window.generatedCode], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `ç”Ÿæˆçš„ç¨‹åº_${new Date().getTime()}.html`;
            a.click();
            URL.revokeObjectURL(a.href);
        });
    </script>
</body>
</html>
